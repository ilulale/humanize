<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Text Humanizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Diff Styling */
        .diff-added {
            background-color: #dcfce7;
            color: #166534;
            text-decoration: none;
            padding: 0 2px;
            border-radius: 2px;
        }
        .diff-removed {
            background-color: #fee2e2;
            color: #991b1b;
            text-decoration: line-through;
            padding: 0 2px;
            border-radius: 2px;
            opacity: 0.7;
        }

        /* Toggle Switch Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="min-h-screen py-8 px-4 md:px-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center flex flex-col items-center">
            <h1 class="text-3xl font-semibold text-slate-800 mb-2">Academic Humanizer</h1>
            <p class="text-slate-500 mb-6">Formal refinement without jargon, dashes, citations, or colons. Supports LaTeX preservation.</p>
            
            <!-- API Key Management -->
            <div class="glass-panel rounded-xl p-3 flex items-center gap-3 w-full max-w-md shadow-sm border border-slate-200">
                <div class="flex-1 flex flex-col">
                    <label for="apiKeyInput" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Gemini API Key</label>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        placeholder="Enter API key or use environment key..."
                        class="bg-transparent border-none focus:ring-0 text-sm text-slate-700 w-full outline-none px-1"
                    />
                </div>
                <button 
                    id="toggleKeyVisibility" 
                    class="p-2 text-slate-400 hover:text-slate-600 transition-colors"
                    title="Toggle Visibility"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </header>

        <!-- Main Workspace -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[600px]">
            
            <!-- Input Area -->
            <div class="flex flex-col h-full glass-panel rounded-2xl p-6 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-sm font-medium text-slate-600 uppercase tracking-wider">Input (Plain Text or LaTeX)</label>
                    <span id="charCount" class="text-xs text-slate-400">0 characters</span>
                </div>
                <textarea 
                    id="inputText" 
                    placeholder="Paste your source text or LaTeX code here..."
                    class="flex-1 w-full bg-transparent border-none focus:ring-0 resize-none text-slate-700 font-mono text-sm leading-relaxed placeholder-slate-300 outline-none"
                ></textarea>
                <div class="mt-4 flex gap-3">
                    <button 
                        id="humanizeBtn"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-xl transition-all duration-200 flex items-center justify-center disabled:opacity-50"
                    >
                        <span id="btnText">Refine Academically</span>
                    </button>
                    <button 
                        id="clearBtn"
                        class="px-4 py-3 text-slate-400 hover:text-slate-600 transition-colors"
                        title="Clear Input"
                    >
                        Clear
                    </button>
                </div>
            </div>

            <!-- Output Area -->
            <div class="flex flex-col h-full glass-panel rounded-2xl p-6 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-slate-600 uppercase tracking-wider">Academic Output</label>
                        <div class="flex items-center gap-2 bg-slate-100 px-2 py-1 rounded-lg">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-tight">Debug Mode</span>
                            <label class="switch">
                                <input type="checkbox" id="debugToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <button 
                        id="copyBtn"
                        class="text-xs font-medium text-indigo-600 hover:text-indigo-800 transition-colors uppercase tracking-wider"
                    >
                        Copy
                    </button>
                </div>
                <div 
                    id="outputText" 
                    class="flex-1 w-full overflow-y-auto text-slate-700 font-mono text-sm leading-relaxed whitespace-pre-wrap empty:before:content-['Refined_content_will_appear_here...'] empty:before:text-slate-300"
                ></div>
                <div id="statusMessage" class="mt-4 text-xs font-medium text-center h-4"></div>
            </div>
        </div>

        <!-- Footer Info -->
        <div class="mt-8 text-center text-slate-400 text-xs">
            Powered by Gemini 2.5 Flash • Academic Tone • LaTeX & Citation Aware • No Hyphens • No Dashes • No Colons
        </div>
    </div>

    <script>
        const apiKey = ""; // Provided by execution environment
        
        const inputEl = document.getElementById('inputText');
        const outputEl = document.getElementById('outputText');
        const charCountEl = document.getElementById('charCount');
        const humanizeBtn = document.getElementById('humanizeBtn');
        const btnText = document.getElementById('btnText');
        const statusMsg = document.getElementById('statusMessage');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const debugToggle = document.getElementById('debugToggle');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const toggleKeyVisibility = document.getElementById('toggleKeyVisibility');

        let lastOriginalText = "";
        let lastRefinedText = "";

        // API Key Storage Logic
        const STORAGE_KEY = 'gemini_humanizer_api_key';
        
        // Initialize API key from storage
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = sessionStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }
        });

        // Save API key on change
        apiKeyInput.addEventListener('input', () => {
            sessionStorage.setItem(STORAGE_KEY, apiKeyInput.value.trim());
        });

        toggleKeyVisibility.addEventListener('click', () => {
            apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
        });

        // Simple word-based diffing algorithm
        function getDiff(original, modified) {
            const out = [];
            const s1 = original.split(/\s+/);
            const s2 = modified.split(/\s+/);
            
            let i = 0, j = 0;
            while (i < s1.length || j < s2.length) {
                if (i < s1.length && j < s2.length && s1[i] === s2[j]) {
                    out.push(s1[i] + " ");
                    i++; j++;
                } else {
                    let foundMatch = false;
                    for (let k = 1; k < 5; k++) {
                        if (i + k < s1.length && s1[i + k] === s2[j]) {
                            for (let m = 0; m < k; m++) {
                                out.push(`<span class="diff-removed">${escapeHtml(s1[i + m])}</span> `);
                            }
                            i += k;
                            foundMatch = true;
                            break;
                        }
                        if (j + k < s2.length && s1[i] === s2[j + k]) {
                            for (let m = 0; m < k; m++) {
                                out.push(`<span class="diff-added">${escapeHtml(s2[j + m])}</span> `);
                            }
                            j += k;
                            foundMatch = true;
                            break;
                        }
                    }
                    
                    if (!foundMatch) {
                        if (i < s1.length) {
                            out.push(`<span class="diff-removed">${escapeHtml(s1[i])}</span> `);
                            i++;
                        }
                        if (j < s2.length) {
                            out.push(`<span class="diff-added">${escapeHtml(s2[j])}</span> `);
                            j++;
                        }
                    }
                }
            }
            return out.join("");
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderOutput() {
            if (!lastRefinedText) return;
            if (debugToggle.checked) {
                outputEl.innerHTML = getDiff(lastOriginalText, lastRefinedText);
            } else {
                outputEl.innerText = lastRefinedText;
            }
        }

        debugToggle.addEventListener('change', renderOutput);

        inputEl.addEventListener('input', () => {
            charCountEl.innerText = `${inputEl.value.length} characters`;
        });

        copyBtn.addEventListener('click', () => {
            const text = lastRefinedText || outputEl.innerText;
            if (!text) return;
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            const originalText = copyBtn.innerText;
            copyBtn.innerText = 'Copied!';
            setTimeout(() => copyBtn.innerText = originalText, 2000);
        });

        clearBtn.addEventListener('click', () => {
            inputEl.value = '';
            outputEl.innerText = '';
            lastOriginalText = "";
            lastRefinedText = "";
            charCountEl.innerText = '0 characters';
        });

        async function humanizeText(text) {
            const activeKey = apiKeyInput.value.trim() || apiKey;
            
            const systemPrompt = `You are an academic text refinement tool. Rewrite the provided content to be formal, professional, and authoritative while remaining direct and clear.
            
            LATEX HANDLING RULES:
            - If the input contains LaTeX syntax (e.g., \\begin, \\section, \\textbf, $math$), you MUST preserve all LaTeX commands, structure, and formatting exactly.
            - Do NOT modify math mode content (anything inside $...$ or $$...$$).
            - Do NOT modify preamble commands or environment definitions.
            - MUST preserve all citation blocks such as \\cite{...}, \\ref{...}, \\citet{...}, \\citep{...}, etc. Do not change the keys inside the braces.
            - ONLY refine the natural language prose/sentences located between or inside LaTeX tags.
            
            GENERAL STYLE RULES:
            1. Use minimal adjectives. Prioritize precise nouns and strong active verbs.
            2. Use clear, simple, yet formal language. Avoid overly complex jargon.
            3. Strictly remove ALL technical artifacts from PROSE: no hyphens, no em dashes (—), and no en dashes (–). (Note: Preserve them if they are part of a LaTeX command or math formula).
            4. Minimize the use of colons (:) in text. Restructure sentences to avoid them.
            5. Remove ALL plain-text citations (e.g., [12], (Author, Year)). However, as noted above, keep all LaTeX \\cite{} commands intact.
            6. Ensure the tone is objective and academic.
            7. Output ONLY the refined content (maintaining full LaTeX structure if applicable).`;

            let retries = 0;
            const maxRetries = 5;

            while (retries <= maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) throw new Error('API request failed');

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";

                } catch (error) {
                    if (retries === maxRetries) throw error;
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    retries++;
                }
            }
        }

        humanizeBtn.addEventListener('click', async () => {
            const text = inputEl.value.trim();
            if (!text) return;

            humanizeBtn.disabled = true;
            btnText.innerHTML = '<span class="loader"></span>Processing...';
            statusMsg.innerText = '';
            statusMsg.className = 'mt-4 text-xs font-medium text-center text-slate-400';
            outputEl.innerText = '';

            try {
                const result = await humanizeText(text);
                lastOriginalText = text;
                lastRefinedText = result;
                renderOutput();
                statusMsg.innerText = 'Refinement complete';
                statusMsg.classList.add('text-green-600');
            } catch (error) {
                console.error(error);
                statusMsg.innerText = 'Error: Could not process content. Please verify your API key and try again.';
                statusMsg.classList.add('text-red-500');
            } finally {
                humanizeBtn.disabled = false;
                btnText.innerText = 'Refine Academically';
            }
        });
    </script>
</body>
</html>
